name: Update OpenTelemetry.io Documentation

env:
  PR_TARGET: "fork"  # Change to "upstream" when ready for production

on:
  schedule:
    # Run nightly at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch: # Allow manual triggers
    inputs:
      version:
        description: 'Specific version to generate docs for (e.g., v0.138.0). Leave empty to use latest.'
        required: false
        type: string

permissions:
  contents: read

jobs:
  update-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout collector-watcher
        uses: actions/checkout@v4
        with:
          path: collector-watcher

      - name: Checkout opentelemetry-collector-contrib
        uses: actions/checkout@v4
        with:
          repository: open-telemetry/opentelemetry-collector-contrib
          path: opentelemetry-collector-contrib
          fetch-depth: 1

      - name: Checkout opentelemetry-collector (core)
        uses: actions/checkout@v4
        with:
          repository: open-telemetry/opentelemetry-collector
          path: opentelemetry-collector
          fetch-depth: 1

      - name: Checkout upstream opentelemetry.io
        uses: actions/checkout@v4
        with:
          repository: open-telemetry/opentelemetry.io
          path: opentelemetry.io
          persist-credentials: false

      - name: Test PAT authentication
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          FORK_OWNER: ${{ secrets.DOCS_REPO_OWNER || github.repository_owner }}
        run: |
          echo "Testing PAT authentication to fork..."

          # Check if token is set
          if [ -z "${GH_TOKEN}" ]; then
            echo "âŒ ERROR: PAT_TOKEN secret is not set"
            exit 1
          fi
          echo "âœ“ PAT_TOKEN is set"

          # Test API access to fork
          echo "Testing API access to ${FORK_OWNER}/opentelemetry.io..."
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: token ${GH_TOKEN}" \
            "https://api.github.com/repos/${FORK_OWNER}/opentelemetry.io")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ ERROR: API request failed with HTTP $HTTP_CODE"
            echo "Response: $(echo "$RESPONSE" | head -n-1)"
            exit 1
          fi
          echo "âœ“ API access successful"

          # Test git push access with a test branch
          cd opentelemetry.io
          git config --unset-all http.https://github.com/.extraheader || true
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create a test branch
          TEST_BRANCH="test-auth-$(date +%s)"
          git checkout -b "${TEST_BRANCH}"
          git commit --allow-empty -m "Test commit for authentication"

          # Try to push
          echo "Testing git push to fork..."
          git remote add fork "https://x-access-token:${GH_TOKEN}@github.com/${FORK_OWNER}/opentelemetry.io.git"

          if git push fork "${TEST_BRANCH}"; then
            echo "âœ“ Git push successful"
            # Clean up test branch
            git push fork --delete "${TEST_BRANCH}" || true
            # Remove the fork remote so it doesn't conflict later
            git remote remove fork
            echo "âœ“ Authentication test passed! Proceeding with workflow..."
          else
            echo "âŒ ERROR: Git push failed"
            exit 1
          fi

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install
        working-directory: collector-watcher

      - name: Install Python dependencies
        run: uv sync
        working-directory: collector-watcher

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: opentelemetry.io/.nvmrc

      - name: Install Node.js dependencies
        run: npm install --omit=optional
        working-directory: opentelemetry.io

      - name: Generate documentation
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            uv run python -m docs_automation.update_docs \
              --docs-repo=../opentelemetry.io \
              --version=${{ inputs.version }}
          else
            uv run python -m docs_automation.update_docs \
              --docs-repo=../opentelemetry.io
          fi
        working-directory: collector-watcher

      - name: Fix spelling errors (add component names to dictionary)
        run: uv run python -m docs_automation.fix_spelling ../opentelemetry.io
        working-directory: collector-watcher
        continue-on-error: true

      - name: Format and fix documentation
        run: npm run test-and-fix
        working-directory: opentelemetry.io
        continue-on-error: true

      - name: Check for documentation changes
        id: check_changes
        run: |
          cd opentelemetry.io
          if git diff --quiet content/en/docs/collector/components/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No documentation changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Documentation changes detected:"
            git --no-pager diff --name-only content/en/docs/collector/components/
          fi

      - name: Get version info
        if: steps.check_changes.outputs.has_changes == 'true'
        id: version_info
        run: |
          cd collector-watcher
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            # Get the latest version from inventory
            VERSION=$(ls -1 collector-metadata/contrib | grep -v SNAPSHOT | sort -V | tail -1)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          # Create a sanitized branch name (replace dots with dashes)
          BRANCH_NAME="collector-docs-${VERSION//\./-}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Configure git
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          cd opentelemetry.io
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create branch and commit changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          cd opentelemetry.io
          git checkout -b ${{ steps.version_info.outputs.branch_name }}
          git add content/en/docs/collector/components/*.md
          git commit -m "Update Collector component tables for ${{ steps.version_info.outputs.version }}"

      - name: Push to fork and create PR
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          FORK_OWNER: ${{ secrets.DOCS_REPO_OWNER || github.repository_owner }}
        run: |
          cd opentelemetry.io

          # Clear any existing git credentials
          git config --unset-all http.https://github.com/.extraheader || true

          # Verify token is set
          if [ -z "${GH_TOKEN}" ]; then
            echo "ERROR: GH_TOKEN is not set. Please configure PAT_TOKEN secret."
            exit 1
          fi

          # Add fork as remote with token authentication (remove first if exists)
          git remote remove fork 2>/dev/null || true
          git remote add fork https://x-access-token:${GH_TOKEN}@github.com/${FORK_OWNER}/opentelemetry.io.git

          # Push branch to fork
          git push -f fork ${{ steps.version_info.outputs.branch_name }}

          # Create PR based on PR_TARGET configuration
          if [ "${{ env.PR_TARGET }}" = "upstream" ]; then
            echo "Creating PR to upstream open-telemetry/opentelemetry.io"
            PR_REPO="open-telemetry/opentelemetry.io"
            PR_HEAD="${FORK_OWNER}:${{ steps.version_info.outputs.branch_name }}"
          else
            echo "Creating PR to fork ${FORK_OWNER}/opentelemetry.io (testing mode)"
            PR_REPO="${FORK_OWNER}/opentelemetry.io"
            PR_HEAD="${{ steps.version_info.outputs.branch_name }}"
          fi

          # Create PR using gh cli
          gh pr create \
            --repo "${PR_REPO}" \
            --head "${PR_HEAD}" \
            --title "Update Collector component tables for ${{ steps.version_info.outputs.version }}" \
            --body "## Update Collector Component Documentation

          This PR updates the OpenTelemetry Collector component tables for version **${{ steps.version_info.outputs.version }}**.

          ### Changes

          Updated component documentation tables in:
          - \`content/en/docs/collector/components/receiver.md\`
          - \`content/en/docs/collector/components/processor.md\`
          - \`content/en/docs/collector/components/exporter.md\`
          - \`content/en/docs/collector/components/connector.md\`
          - \`content/en/docs/collector/components/extension.md\`

          ---

          ðŸ¤– _This PR was automatically generated by [collector-watcher](https://github.com/${{ github.repository }})_

          **Target:** ${PR_REPO} (mode: ${{ env.PR_TARGET }})"
